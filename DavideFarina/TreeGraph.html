<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap</title>
	<link href="TreeGraph_files/style.css" rel="stylesheet">
    <link href="TreeGraph_files/bootstrap.css" rel="stylesheet">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
	<script src="TreeGraph_files/three.js"></script>
 <script src="TreeGraph_files/OrbitControls.js"></script>
		<script src="TreeGraph_files/THREEx.js"></script>

	<div id="wrapper">
		<nav id="topnavbar" class="navbar navbar-default" role="navigation">
  			<div class="container-fluid">
    			<div class="navbar-header">
      				<img src="TreeGraph_files/logograssetto.png" id="logoimage">
    			</div>
    			<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      	  				<ul class="nav navbar-nav navbar-right">
							<ul class="nav navbar-nav">
							<li class="activetab"><a href="#">HOME</a></li>
        					<li><a href="#">UPLOAD</a></li>
        					<li><a href="#">TASKS</a></li>
							<li><a href="">ABOUT THE PROJECT</a></li>
               				<li><a href="">CONTACTS</a></li>
        				</ul>
          				<li class="dropdown">
            			<a href="#" class="dropdown" data-toggle="dropdown">LOGIN<span id="caretlogin" class="caret"></span></a>
            				<div id="logindropdown" class="dropdown-menu">
              					<form class="form" id="formLogin"> 
                					<div class="input-group">
  										<span class="input-group-addon">
											<span class="glyphicon glyphicon-user"></span>
										</span>
  										<input class="form-control" placeholder="Username" type="text">
									</div>
									<br>
									<div class="input-group">
  										<span class="input-group-addon">
											<span class="glyphicon glyphicon-asterisk"></span>
										</span>
  										<input class="form-control" placeholder="Password" type="password">
									</div>
									<br>
									<button id="loginbutton" type="button" class="btn btn-default">Submit</button>
              					</form>
            				</div>
          				</li>
      				</ul>
    			</div>
  			</div>
		</nav>
		<div class="navseparator"></div>
		<main>
			<div align="center"><p>Controls: "O" and "P" to resize the points. 
Right mouse button to move the graph. Left mouse button to rotate the 
graph. Press mouse wheel to zoom.</p></div>
			<div id="threeJsCanvas" style="position: static;" align="center"></canvas></div>
<!-- ----------------------------------------------------------------------------------------------------------------------------------- -->
        <script type="text/javascript">
function ajaxRequest(){
    var activexmodes=["Msxml2.XMLHTTP", "Microsoft.XMLHTTP"] //activeX versions to check for in IE
    if (window.ActiveXObject){ //Test for support for ActiveXObject in IE first (as XMLHttpRequest in IE7 is broken)
        for (var i=0; i<activexmodes.length; i++){
            try{
                return new ActiveXObject(activexmodes[i])
            }
            catch(e){
    //suppress error
            }
        }
    }
    else if (window.XMLHttpRequest) // if Mozilla, Safari etc
        return new XMLHttpRequest()
 else
  return false
}

var r ;
var call = function(url) {
    var a = new ajaxRequest ();

    a.open("GET", url, false);
    a.send(null);
    r = a.responseText;

}

// standard global variables
var container, scene, camera, renderer, controls;

document.addEventListener( 'mousedown', onDocumentMouseDown, false );
var projector = new THREE.Projector();

//My Variables
var objects = []; //contains the 3D points of the graph
var XSize = 940;
var YSize = 600;
var edges = [];
var parsedPointsJson = [];
var parsedBoxPlotsJson = [];
var rankRatio = 200;
var maxZ = 0;

var camerahelper;

init();
animate();
			
function init() 
{

    container = document.getElementById("threeJsCanvas");
	//document.body.appendChild(container);

	scene = new THREE.Scene();
	keyboard = new THREEx.KeyboardState();
	
	// camera attributes
	var VIEW_ANGLE = 45, ASPECT = XSize/YSize, NEAR = 0.1, FAR = 20000;
	// set up camera
	camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
	
	// add the camera to the scene
	scene.add(camera);
	camera.position.set(0,-4,1);
	camera.lookAt(new THREE.Vector3(0, 0, 0));	
	camera.rotation.set(Math.PI / 2, 0, 0);

    renderer = new THREE.WebGLRenderer({antialias: true});
		        renderer.setSize(window.innerWidth, window.innerHeight);
	renderer.setSize(XSize, YSize);

	container = document.getElementById("threeJsCanvas");
    //document.body.appendChild( container );
	
	container.appendChild( renderer.domElement );
	
	controls = new THREE.OrbitControls( camera, renderer.domElement );
	controls.target = new THREE.Vector3(0, 0, 0);
	
	///////////
	// LIGHT //
	///////////
	
	var light = new THREE.PointLight(0xffffff);
	light.position.set(10, 10, 10);
	scene.add(light);
	var ambientLight = new THREE.AmbientLight(0x666666);
	scene.add(ambientLight);

	/////////////
	// DRAWING //
	/////////////

	call("http://localhost/DavideFarina/prova_json_2.txt");
	ParsePointsJSON();
	CreateGraph();
	call("http://localhost/DavideFarina/boxPlotsData.txt");
	ParseBoxPlotsJSON();
	CreateBoxPlots();
}

function ParsePointsJSON() {
	var parsed = JSON.parse(r);
	for(i in parsed.data) {
		parsedPointsJson.push(parsed.data[i]);
		if(parsedPointsJson[i].rank > maxZ)
			maxZ = parsedPointsJson[i].rank; }
}

function ParseBoxPlotsJSON() {
	var parsed = JSON.parse(r);
	for(i in parsed.data)
		parsedBoxPlotsJson.push(parsed.data[i]);
}

function CreateGraph() {
	var maxCoord = 0; //the biggest |coord|

	var sphereGeom = new THREE.SphereGeometry(0.02, 16, 16);
	/*var tmpMat = new THREE.MeshLambertMaterial({color: 0x0000ff});
	var center = new THREE.Mesh(sphereGeom, tmpMat);
	scene.add(center);*/

	for(i in objects)
		scene.remove(objects[i])

	for(i in parsedPointsJson) {
		
		if(parsedPointsJson[i].x > maxCoord)
			maxCoord = parsedPointsJson[i].x;
		else if(parsedPointsJson[i].x * -1 > maxCoord)
			maxCoord = parsedPointsJson[i].x * -1;
		else if(parsedPointsJson[i].y > maxCoord)
			maxCoord = parsedPointsJson[i].y;
		else if(parsedPointsJson[i].y * -1 > maxCoord)
			maxCoord = parsedPointsJson[i].y * -1;
		else if(Math.log10(parsedPointsJson[i].rank + 1)> maxCoord)
			maxCoord = Math.log10(parsedPointsJson[i].rank + 1);
		else if(Math.log10(parsedPointsJson[i].rank + 1) * -1> maxCoord)
			maxCoord = Math.log10(parsedPointsJson[i].rank + 1) * -1;

		var sphereMat;
		if(parsedPointsJson[i].id == 1)
			sphereMat = new THREE.MeshLambertMaterial({color: 0x000000, wireframe:false, ambient:0x000000});
		else
			sphereMat = new THREE.MeshLambertMaterial({color: 0x0000ff, wireframe:false, ambient:0x444444});
		var sphere = new THREE.Mesh(sphereGeom, sphereMat);
		if(parsedPointsJson[i].rank != 0)
			sphere.position.set(parsedPointsJson[i].x, parsedPointsJson[i].y, Math.log10(parsedPointsJson[i].rank + 1) * -1);
		else
			sphere.position.set(parsedPointsJson[i].x, parsedPointsJson[i].y, Math.log10(maxZ + 1) * -1);
		//sphere.position.set(parsedPointsJson[i].x, parsedPointsJson[i].y, 0);
		objects.push(sphere);
		objects[i].id = parsedPointsJson[i].id;
		objects[i].childs = parsedPointsJson[i].childs;
		scene.add(sphere);
	}
	//at this point "objects" has every sphere with every id. We can now do the edges.
	/*for(i in objects) {
		for(j in objects[i].childs) 
			drawEdge(objects[i], objects[objects[i].childs[j]]);
	}*/
	for(i in objects)
		for (j in objects[i].childs)
			for(k in objects)
				if(objects[k].id == objects[i].childs[j]) {
					if(objects[k].childs.length == 0)
						drawEdge(objects[i], objects[k], true);
					else
						drawEdge(objects[i], objects[k], false);
					break; }

	var containerGeom = new THREE.CubeGeometry(maxCoord * 2 + 0.5, maxCoord * 2+ 0.5, maxCoord * 2 + 0.5, 5, 5, 5);
	containerGeom.applyMatrix(new THREE.Matrix4().makeScale( -1, 1, 1 ) ); //flips the normals

	var texture = THREE.ImageUtils.loadTexture( "gridBigger.png" );
	var containerMat = new THREE.MeshLambertMaterial({map:texture});
	var container = new THREE.Mesh(containerGeom, containerMat);

	container.position.set(0, 0, 0);
	scene.add(container);

}

function CreateBoxPlots() {
/*
	var group = new THREE.Object3D();
		//still needs the rotation
	for(i in parsedBoxPlotsJson) {
		var boxGeom = new THREE.CubeGeometry(0.01, 0.01, eval(parsedBoxPlotsJson[i].end1 - parsedBoxPlotsJson[i].start1)/10, 1, 1, 1);
		var boxMat = new THREE.MeshLambertMaterial({color: 0xdddddd});
		var box = new THREE.Mesh(boxGeom, boxMat);	
		box.position.set(objects[i].position.x, objects[i].position.y, 0.01 + objects[i].position.z + parsedBoxPlotsJson[i].start1 / 10);		
		group.add(box);
	}

	for(i in parsedBoxPlotsJson) {
		var boxGeom = new THREE.CubeGeometry(0.01, 0.01, eval(parsedBoxPlotsJson[i].end2 - parsedBoxPlotsJson[i].start2)/10, 1, 1, 1);
		var boxMat = new THREE.MeshLambertMaterial({color: 0xdddddd});
		var box = new THREE.Mesh(boxGeom, boxMat);
		box.position.set(objects[i].position.x + 0.02, objects[i].position.y, 0.01 + objects[i].position.z + parsedBoxPlotsJson[i].start2 / 10 - (eval(parsedBoxPlotsJson[i].end1 - parsedBoxPlotsJson[i].start1)/10 - eval(parsedBoxPlotsJson[i].end2 - parsedBoxPlotsJson[i].start2)/10)/2 );				
		group.add(box);
	}
	group.rotation.set(0, Math.PI/2, 0);
	scene.add(group);
*/
		//still needs the rotation
	for(i in parsedBoxPlotsJson) {
		var group = new THREE.Object3D();
		var boxGeom1 = new THREE.CubeGeometry(0.01, 0.01, eval(parsedBoxPlotsJson[i].end1 - parsedBoxPlotsJson[i].start1)/10, 1, 1, 1);
		var boxMat1 = new THREE.MeshLambertMaterial({color: 0xff0000});
		var box1 = new THREE.Mesh(boxGeom1, boxMat1);	
		box1.position.set(-0.008, 0, -0.06 + parsedBoxPlotsJson[i].start1 / 10 + (parsedBoxPlotsJson[i].end1 - parsedBoxPlotsJson[i].start1)/ 20);
		group.add(box1);

		var boxGeom2 = new THREE.CubeGeometry(0.01, 0.01, eval(parsedBoxPlotsJson[i].end2 - parsedBoxPlotsJson[i].start2)/10, 1, 1, 1);
		var boxMat2 = new THREE.MeshLambertMaterial({color: 0xdddddd});
		var box2 = new THREE.Mesh(boxGeom2, boxMat2);
		box2.position.set(0.008, 0, -0.06 + parsedBoxPlotsJson[i].start2 / 10 + (parsedBoxPlotsJson[i].end2 - parsedBoxPlotsJson[i].start2)/20);
		group.add(box2);

		group.rotation.set(0, 0, Math.PI / 2);
		group.position.set(objects[i].position.x, objects[i].position.y, objects[i].position.z + 0.1);
		scene.add(group);
	}
}

function onWindowResize() {
	camera.left = window.innerWidth / -2;
	camera.right = window.innerWidth / 2;
	camera.top = window.innerHeight / 2;
	camera.bottom = window.innerHeight / -2;
	camera.updateProjectionMatrix();
	camerahelper.update();
	renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() 
{
    requestAnimationFrame( animate );
	render();	
}



function render() 
{	
	renderer.render( scene, camera );
}

function drawEdge(source, target, semitransparent) { //draws an edge from "source" to "target"
	var lineGeom = new THREE.Geometry();
	var lineMat;
	if(!semitransparent)
		lineMat = new THREE.LineBasicMaterial({ color: 0x000066, opacity: 1, linewidth: 1, transparent: true });
	else
		lineMat = new THREE.LineBasicMaterial({ color: 0x000066, opacity: 0.5, linewidth: 1, transparent: true });
	lineMat.depthWrite = false;
	lineGeom.vertices.push(source.position);
	lineGeom.vertices.push(target.position);

	line = new THREE.Line( lineGeom, lineMat, THREE.LinePieces );
	line.scale.x = line.scale.y = line.scale.z = 1;
	line.originalScale = 10;
				
	edges.push(line);
	scene.add( line );
}


function onDocumentMouseDown( event ) { //called when the user clicks
    event.preventDefault();

    var vector = new THREE.Vector3(
        ( ( event.clientX - renderer.domElement.offsetLeft ) / renderer.domElement.width ) * 2 - 1, //5px is the correction for the border around the canvas
      - ( ( event.clientY + window.pageYOffset - renderer.domElement.offsetTop ) / renderer.domElement.height ) * 2 + 1,
        0.5
    );
    projector.unprojectVector( vector, camera );
    var ray = new THREE.Raycaster( camera.position, 
                             vector.sub( camera.position ).normalize() );
	ray.far = 1000;
	ray.near = 1;
	ray.precision = 1;
    var intersects = ray.intersectObjects( objects );

    if ( intersects.length > 0 ) { // called when the user clicks on an object

	}
}

</script>

<div align="center"><div id="data-table-cont"></div><table id="data-table"></table></div>
		</main>
		<div class="navseparator"></div>
		<nav id="bottomnavbar" class="navbar navbar-default" role="navigation">
  			<div id="footercontainer" class="container">
				<div id="footerleft"> 
					<b>Contacts:</b>
					<ul id="contactlist">
						<li><a href="http://www.fbk.eu/">FBK Fondazione Bruno Kessler - Trento - +39 0461 314200</a></li> 
        				<li><a href="https://webvalley.fbk.eu/">WebValley - FBK</a></li>
						<li><a href="http://www.ospedalebambinogesu.it/home">Ospedale Bambino Gesu' - Roma - urp@opbg.net</a></li>
					</ul>
				</div>
				<div id="footerright">
					<img src="TreeGraph_files/logoCassaRurale.png" class="logofooter" alt="Cassa Rurale logo">
    				<img src="TreeGraph_files/logoComano.png" class="logofooter" alt="Comano logo">
				</div> 
  			</div>
		</nav>
	</div>

    <script src="TreeGraph_files/jquery.js"></script>
    <script src="TreeGraph_files/bootstrap.js"></script>
  

</body></html>
